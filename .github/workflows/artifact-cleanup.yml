name: Artifact Cleanup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  cleanup-artifacts:
    name: Clean up old artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            const now = Date.now();
            const retentionPeriods = {
              'test-results': 30 * 24 * 60 * 60 * 1000, // 30 days
              'screenshots': 7 * 24 * 60 * 60 * 1000,   // 7 days
              'videos': 7 * 24 * 60 * 60 * 1000,        // 7 days
              'traces': 7 * 24 * 60 * 60 * 1000         // 7 days
            };
            
            for (const artifact of artifacts.data.artifacts) {
              const artifactAge = now - new Date(artifact.created_at).getTime();
              
              // Determine retention period based on artifact name
              let retentionPeriod = 7 * 24 * 60 * 60 * 1000; // Default 7 days
              for (const [prefix, period] of Object.entries(retentionPeriods)) {
                if (artifact.name.startsWith(prefix)) {
                  retentionPeriod = period;
                  break;
                }
              }
              
              // Delete if older than retention period
              if (artifactAge > retentionPeriod) {
                console.log(`Deleting artifact: ${artifact.name} (${Math.floor(artifactAge / (24 * 60 * 60 * 1000))} days old)`);
                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id
                });
              }
            }
